name: Sync Master Repo

on:
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: sync-private-keep-workflows
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest

    env:
      SOURCE_REPO: https://github.com/amirtaherkhani/net-block.git
      SOURCE_BRANCH: main
      TARGET_BRANCH: main
      KEEP_PATH: .github/workflows

    steps:
      - name: Checkout private target branch
        uses: actions/checkout@v4
        with:
          ref: ${{ env.TARGET_BRANCH }}
          fetch-depth: 0
          fetch-tags: true

      - name: Configure git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch private origin and public source
        run: |
          git fetch --prune origin "${TARGET_BRANCH}"
          if git remote get-url public >/dev/null 2>&1; then
            git remote set-url public "${SOURCE_REPO}"
          else
            git remote add public "${SOURCE_REPO}"
          fi
          git fetch --prune public "${SOURCE_BRANCH}"
          git fetch --prune --tags public

      - name: Save private workflow files from origin/main
        run: |
          rm -rf /tmp/keep-workflows
          mkdir -p /tmp/keep-workflows
          # Extract private repo workflows as they exist in origin/main
          if git ls-tree -r --name-only "origin/${TARGET_BRANCH}" | grep -q "^${KEEP_PATH}/"; then
            git archive "origin/${TARGET_BRANCH}" "${KEEP_PATH}" | tar -x -C /tmp/keep-workflows
            echo "Found and saved private workflows."
          else
            echo "No ${KEEP_PATH} in origin/${TARGET_BRANCH}; nothing to preserve."
          fi

      - name: Force reset branch to public source
        run: |
          git checkout "${TARGET_BRANCH}"
          git reset --hard "public/${SOURCE_BRANCH}"

      - name: Restore private workflow files
        run: |
          if [ -d "/tmp/keep-workflows/${KEEP_PATH}" ]; then
            mkdir -p "${KEEP_PATH}"
            cp -R /tmp/keep-workflows/${KEEP_PATH}/. "${KEEP_PATH}/"
            git add "${KEEP_PATH}"
          fi

          # If public has workflows not in private, remove them from index/worktree
          # so final state matches private workflows only.
          if [ -d "${KEEP_PATH}" ] && [ -d "/tmp/keep-workflows/${KEEP_PATH}" ]; then
            find "${KEEP_PATH}" -type f | while read -r f; do
              rel="${f#./}"
              if [ ! -f "/tmp/keep-workflows/${rel}" ]; then
                git rm -f -- "${rel}" || true
              fi
            done
            # Ensure preserved files are staged
            git add "${KEEP_PATH}" || true
          fi

      - name: Commit preserved workflow restoration (if needed)
        run: |
          if ! git diff --cached --quiet; then
            git commit -m "chore(sync): preserve private .github/workflows while syncing from public"
          else
            echo "No workflow changes to commit."
          fi

      - name: Force push target branch
        run: |
          git push --force origin "${TARGET_BRANCH}"

      - name: Sync tags from public (optional; remove if not needed)
        run: |
          git push --force origin --tags