name: Sync Master Repo

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    env:
      SRC_REPO: https://github.com/amirtaherkhani/next-block.git
      SRC_BRANCH: main
      DST_BRANCH: main
      KEEP_PATH: .github/workflows

    steps:
      - name: Checkout private repo (light)
        uses: actions/checkout@v3
        with:
          ref: ${{ env.DST_BRANCH }}
          fetch-depth: 1
          fetch-tags: false

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch origin with retry
        run: |
          set -e
          for i in 1 2 3 4 5; do
            git fetch --prune origin "${DST_BRANCH}" && break
            echo "origin fetch failed attempt $i, retrying..."
            sleep 10
            if [ "$i" = "5" ]; then exit 1; fi
          done

      - name: Add/fetch public with retry
        run: |
          if git remote get-url public >/dev/null 2>&1; then
            git remote set-url public "${SRC_REPO}"
          else
            git remote add public "${SRC_REPO}"
          fi

          set -e
          for i in 1 2 3 4 5; do
            git fetch --prune public "${SRC_BRANCH}" && git fetch --prune --tags public && break
            echo "public fetch failed attempt $i, retrying..."
            sleep 10
            if [ "$i" = "5" ]; then exit 1; fi
          done

      - name: Backup private workflows
        run: |
          rm -rf /tmp/keep && mkdir -p /tmp/keep
          if git ls-tree -r --name-only "origin/${DST_BRANCH}" | grep -q "^${KEEP_PATH}/"; then
            git archive "origin/${DST_BRANCH}" "${KEEP_PATH}" | tar -x -C /tmp/keep
          fi

      - name: Reset to public
        run: |
          git checkout "${DST_BRANCH}"
          git reset --hard "public/${SRC_BRANCH}"

      - name: Restore private workflows
        run: |
          if [ -d "/tmp/keep/${KEEP_PATH}" ]; then
            mkdir -p "${KEEP_PATH}"
            cp -R /tmp/keep/${KEEP_PATH}/. "${KEEP_PATH}/"
            git add "${KEEP_PATH}" || true
          fi

      - name: Commit if workflow files changed
        run: |
          if ! git diff --cached --quiet; then
            git commit -m "chore(sync): keep private workflows"
          fi

      - name: Force push branch
        run: |
          git push --force origin "${DST_BRANCH}"

      - name: Sync tags
        run: |
          git push --force origin --tags