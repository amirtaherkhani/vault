name: Sync Master Repo

on:
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: sync-private-no-checkout
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    env:
      PUBLIC_OWNER: amirtaherkhani
      PUBLIC_REPO: next-block
      PUBLIC_BRANCH: main

      PRIVATE_OWNER: Metapolitanltd
      PRIVATE_REPO: VeroVaultBackend
      PRIVATE_BRANCH: main

      KEEP_PATH: .github/workflows

    steps:
      - name: Prepare workspace
        run: |
          set -euo pipefail
          mkdir -p /tmp/sync-work
          cd /tmp/sync-work

      - name: Download public source tarball (with retry)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          cd /tmp/sync-work
          url="https://api.github.com/repos/${PUBLIC_OWNER}/${PUBLIC_REPO}/tarball/${PUBLIC_BRANCH}"

          for i in 1 2 3 4 5; do
            if curl -fL \
              -H "Authorization: Bearer ${GH_TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              "$url" -o public.tar.gz; then
              break
            fi
            echo "public tarball download failed ($i/5), retrying in 8s..."
            sleep 8
            [ "$i" -lt 5 ] || exit 1
          done

          mkdir public
          tar -xzf public.tar.gz -C public --strip-components=1

      - name: Download private current branch tarball for workflow preservation
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          cd /tmp/sync-work
          url="https://api.github.com/repos/${PRIVATE_OWNER}/${PRIVATE_REPO}/tarball/${PRIVATE_BRANCH}"

          for i in 1 2 3 4 5; do
            if curl -fL \
              -H "Authorization: Bearer ${GH_TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              "$url" -o private.tar.gz; then
              break
            fi
            echo "private tarball download failed ($i/5), retrying in 8s..."
            sleep 8
            [ "$i" -lt 5 ] || exit 1
          done

          mkdir private
          tar -xzf private.tar.gz -C private --strip-components=1

      - name: Build final tree (public + preserved private workflows)
        run: |
          set -euo pipefail
          cd /tmp/sync-work

          rm -rf final
          mkdir -p final
          cp -R public/. final/

          if [ -d "private/${KEEP_PATH}" ]; then
            mkdir -p "final/${KEEP_PATH}"
            rm -rf "final/${KEEP_PATH}"
            cp -R "private/${KEEP_PATH}" "final/${KEEP_PATH}"
            echo "Preserved private workflows from private/${KEEP_PATH}"
          else
            echo "No private workflows found to preserve."
          fi

      - name: Commit and force-push to private main
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          cd /tmp/sync-work/final

          git init
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore(sync): sync master repo"
          fi

          git branch -M "${PRIVATE_BRANCH}"
          git remote add origin "https://x-access-token:${GH_TOKEN}@github.com/${PRIVATE_OWNER}/${PRIVATE_REPO}.git"

          for i in 1 2 3 4 5; do
            if git push --force origin "${PRIVATE_BRANCH}"; then
              break
            fi
            echo "push failed ($i/5), retrying in 10s..."
            sleep 10
            [ "$i" -lt 5 ] || exit 1
          done